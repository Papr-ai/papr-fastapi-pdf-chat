<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Chat with Papr Memory</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">üí¨ Chat with Your PDF Documents</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
            <!-- Left Sidebar: Upload & Document List -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Upload Section -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">üì§ Upload Documents</h2>
                    
                    <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer">
                        <div class="space-y-3">
                            <div class="text-3xl">üìÑ</div>
                            <div>
                                <p class="font-medium text-gray-700">Drop PDF here</p>
                                <p class="text-sm text-gray-500">or click to upload</p>
                            </div>
                            <input type="file" id="file-input" class="hidden" accept=".pdf" />
                        </div>
                    </div>
                    
                    <!-- Upload Status -->
                    <div id="upload-progress" class="hidden mt-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                                <span class="text-blue-800 text-sm" id="progress-text">Processing...</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="upload-success" class="hidden mt-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="flex items-center space-x-2">
                                <div class="text-green-600">‚úÖ</div>
                                <span class="text-green-800 text-sm">Uploaded successfully!</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="upload-error" class="hidden mt-4">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                            <div class="flex items-center space-x-2">
                                <div class="text-red-600">‚ùå</div>
                                <div>
                                    <p class="text-red-800 text-sm font-medium">Upload failed</p>
                                    <p id="error-message" class="text-red-600 text-xs"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Document List -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">üìö Your Documents</h2>
                    <div id="document-list" class="space-y-2">
                        <div class="text-gray-500 text-sm text-center py-4">
                            No documents uploaded yet
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Side: Chat Interface -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 h-[600px] flex flex-col">
                    <!-- Chat Header -->
                    <div class="border-b border-gray-200 p-4">
                        <div id="chat-header-empty" class="text-gray-500 text-center">
                            üí¨ Chat with Your Documents
                            <p class="text-sm mt-1">Upload PDFs to start chatting across all your documents</p>
                        </div>
                        <div id="chat-header-active" class="hidden">
                            <div class="flex items-center space-x-3">
                                <div class="text-2xl">üìÑ</div>
                                <div>
                                    <p class="font-semibold text-gray-800" id="active-document-name">Document Name</p>
                                    <p class="text-sm text-gray-500" id="active-document-id">Document ID</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4">
                        <div id="welcome-message" class="text-gray-500 text-center py-8">
                            Start by uploading PDF documents, then ask questions - I'll search across all your documents!
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="border-t border-gray-200 p-4">
                        <div class="flex space-x-3">
                            <input 
                                type="text" 
                                id="chat-input" 
                                placeholder="Ask a question about your document..." 
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                disabled
                            />
                            <button 
                                id="send-btn" 
                                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                                disabled
                            >
                                Send
                            </button>
                        </div>
      
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class PDFChatApp {
            constructor() {
                this.documents = [];
                this.activeDocumentId = null;
                this.initializeElements();
                this.setupEventListeners();
                this.loadExistingDocuments();
            }

            initializeElements() {
                this.uploadArea = document.getElementById('upload-area');
                this.fileInput = document.getElementById('file-input');
                this.uploadProgress = document.getElementById('upload-progress');
                this.uploadSuccess = document.getElementById('upload-success');
                this.uploadError = document.getElementById('upload-error');
                this.errorMessage = document.getElementById('error-message');
                this.progressText = document.getElementById('progress-text');
                this.progressBar = document.getElementById('progress-bar');
                this.documentList = document.getElementById('document-list');
                this.chatHeaderEmpty = document.getElementById('chat-header-empty');
                this.chatHeaderActive = document.getElementById('chat-header-active');
                this.activeDocumentName = document.getElementById('active-document-name');
                this.activeDocumentId = document.getElementById('active-document-id');
                this.chatMessages = document.getElementById('chat-messages');
                this.welcomeMessage = document.getElementById('welcome-message');
                this.chatInput = document.getElementById('chat-input');
                this.sendBtn = document.getElementById('send-btn');
                // this.summarizeBtn = document.getElementById('summarize-btn'); // Element doesn't exist
            }

            setupEventListeners() {
                // Upload events
                if (this.uploadArea) {
                    this.uploadArea.addEventListener('click', () => this.fileInput.click());
                    this.uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
                    this.uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
                    this.uploadArea.addEventListener('drop', this.handleDrop.bind(this));
                }
                if (this.fileInput) {
                    this.fileInput.addEventListener('change', this.handleFileSelect.bind(this));
                }

                // Chat events
                if (this.sendBtn) {
                    this.sendBtn.addEventListener('click', this.sendMessage.bind(this));
                }
                // Summarize button doesn't exist in current UI
                // if (this.summarizeBtn) {
                //     this.summarizeBtn.addEventListener('click', this.summarizeDocument.bind(this));
                // }
                if (this.chatInput) {
                    this.chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.sendMessage();
                    });
                }
            }

            handleDragOver(e) {
                e.preventDefault();
                this.uploadArea.classList.add('border-blue-400', 'bg-blue-50');
            }

            handleDragLeave(e) {
                e.preventDefault();
                this.uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
            }

            handleDrop(e) {
                e.preventDefault();
                this.uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.uploadFile(files[0]);
                }
            }

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    this.uploadFile(file);
                }
            }

            async uploadFile(file) {
                if (!file.type.includes('pdf')) {
                    this.showError('Please select a PDF file.');
                    return;
                }

                if (file.size > 50 * 1024 * 1024) {
                    this.showError('File size must be less than 50MB.');
                    return;
                }

                // Generate unique upload ID
                const uploadId = 'upload_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                this.showProgress('Starting upload...', 0);

                const formData = new FormData();
                formData.append('file', file);

                try {
                    // Start listening to progress updates first
                    this.streamProgress(uploadId, file.name);
                    
                    // Then start the upload
                    const response = await fetch(`/upload/with-progress/${uploadId}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();

                    if (!response.ok) {
                        this.showError(result.detail || 'Upload failed');
                        return;
                    }
                    
                    console.log('Upload request completed:', result);
                    
                } catch (error) {
                    this.showError(error.message);
                }
            }
            
            streamProgress(uploadId, filename) {
                // Use regular polling instead of SSE for simplicity
                let attempts = 0;
                const maxAttempts = 60; // 60 attempts = 30 seconds max
                
                const checkProgress = async () => {
                    try {
                        console.log(`Checking progress for ${uploadId} (attempt ${attempts + 1})`);
                        const response = await fetch(`/upload/progress/${uploadId}`);
                        if (response.ok) {
                            const progress = await response.json();
                            console.log(`Progress update:`, progress);
                            
                            // Update progress bar
                            this.showProgress(progress.message, progress.percent);
                            
                            if (progress.status === 'complete') {
                                const result = progress.result;
                                this.addDocument({
                                    id: result.document_id,
                                    filename: result.filename || filename,
                                    uploadedAt: new Date(),
                                    chunks: result.chunks_created
                                });
                                
                                setTimeout(() => {
                                    this.showSuccess();
                                    setTimeout(() => this.hideStatus(), 3000);
                                }, 500);
                                return; // Stop polling
                            } else if (progress.status === 'error') {
                                this.showError(progress.message);
                                return; // Stop polling
                            }
                            
                            // Continue polling if still processing
                            if (progress.status === 'processing') {
                                setTimeout(checkProgress, 300);
                            }
                        } else if (response.status === 404) {
                            // Upload not found yet, retry with backoff
                            attempts++;
                            if (attempts < maxAttempts) {
                                console.log(`Upload ${uploadId} not found yet, retrying... (${attempts}/${maxAttempts})`);
                                setTimeout(checkProgress, attempts < 5 ? 500 : 1000); // Faster initial retries
                            } else {
                                this.showError('Upload tracking failed - please try again');
                            }
                        } else {
                            // Other HTTP errors
                            const errorData = await response.json().catch(() => ({}));
                            this.showError(errorData.detail || 'Upload progress check failed');
                        }
                    } catch (error) {
                        attempts++;
                        console.error('Error checking progress:', error);
                        if (attempts < maxAttempts) {
                            setTimeout(checkProgress, 1000); // Retry after 1 second
                        } else {
                            this.showError('Connection error - please try again');
                        }
                    }
                };
                
                // Start polling with a delay to allow upload endpoint to initialize
                setTimeout(checkProgress, 1000); // Increased delay
            }

            addDocument(doc) {
                this.documents.push(doc);
                this.updateDocumentList();
                this.enableChat(); // Enable chat when any document is available
            }

            enableChat() {
                // Enable chat when any documents are available
                if (this.documents.length > 0) {
                    this.chatHeaderEmpty.classList.add('hidden');
                    this.chatHeaderActive.classList.remove('hidden');
                    this.activeDocumentName.textContent = `${this.documents.length} document${this.documents.length > 1 ? 's' : ''} available`;
                    const docIdElement = document.getElementById('active-document-id');
                    if (docIdElement) {
                        docIdElement.textContent = 'Search across all documents';
                    }
                    
                    this.chatInput.disabled = false;
                    this.sendBtn.disabled = false;
                    this.chatInput.placeholder = 'Ask a question about your documents...';
                    
                    this.clearChatMessages();
                    this.chatInput.focus();
                } else {
                    // No documents available
                    this.chatHeaderEmpty.classList.remove('hidden');
                    this.chatHeaderActive.classList.add('hidden');
                    this.chatInput.disabled = true;
                    this.sendBtn.disabled = true;
                    this.chatInput.placeholder = 'Upload a document to start chatting...';
                }
            }

            updateDocumentList() {
                if (this.documents.length === 0) {
                    this.documentList.innerHTML = `
                        <div class="text-gray-500 text-sm text-center py-4">
                            No documents uploaded yet
                        </div>
                    `;
                    return;
                }

                this.documentList.innerHTML = this.documents.map(doc => {
                    const uploadDate = doc.uploadedAt ? doc.uploadedAt.toLocaleDateString() : 'Recently';
                    const chunkInfo = doc.chunks ? `${doc.chunks} chunks` : '';
                    const sizeInfo = doc.fileSize ? `${Math.round(doc.fileSize / 1024)}KB` : '';
                    const metaInfo = [uploadDate, chunkInfo, sizeInfo].filter(Boolean).join(' ‚Ä¢ ');
                    
                    return `
                    <div class="document-item p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex items-start space-x-3">
                            <div class="text-lg flex-shrink-0">üìÑ</div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-800 truncate" title="${doc.filename}">${doc.filename}</p>
                                <p class="text-xs text-gray-500 mt-1">${metaInfo}</p>
                                <p class="text-xs text-green-600 mt-1">‚úì Available for search</p>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            }

            async sendMessage() {
                const message = this.chatInput.value.trim();
                if (!message) return;

                this.addChatMessage('user', message);
                this.chatInput.value = '';

                const loadingId = this.addChatMessage('assistant', 'Thinking...', true);

                try {
                    const response = await fetch('/chat/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: message
                            // Remove document_id - search across all documents
                        })
                    });

                    const result = await response.json();
                    this.removeChatMessage(loadingId);

                    if (response.ok) {
                        this.addChatMessage('assistant', result.response, false, result.sources);
                    } else {
                        this.addChatMessage('assistant', `Error: ${result.error || result.detail}`);
                    }
                } catch (error) {
                    this.removeChatMessage(loadingId);
                    this.addChatMessage('assistant', `Error: ${error.message}`);
                }
            }

            async summarizeDocument() {
                if (!this.activeDocumentId) return;

                const loadingId = this.addChatMessage('assistant', 'Generating document summary...', true);

                try {
                    const response = await fetch('/chat/summarize', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            document_id: this.activeDocumentId
                        })
                    });

                    const result = await response.json();
                    this.removeChatMessage(loadingId);

                    if (response.ok) {
                        this.addChatMessage('assistant', result.summary);
                    } else {
                        this.addChatMessage('assistant', `Error generating summary: ${result.error || result.detail}`);
                    }
                } catch (error) {
                    this.removeChatMessage(loadingId);
                    this.addChatMessage('assistant', `Error: ${error.message}`);
                }
            }

            addChatMessage(sender, content, isLoading = false, sources = null) {
                const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const isUser = sender === 'user';
                
                if (this.welcomeMessage && !this.welcomeMessage.classList.contains('hidden')) {
                    this.welcomeMessage.classList.add('hidden');
                }

                const messageDiv = document.createElement('div');
                messageDiv.id = messageId;
                messageDiv.className = `mb-4 ${isUser ? 'text-right' : 'text-left'}`;
                
                let sourcesHtml = '';
                if (sources && sources.length > 0) {
                    sourcesHtml = `
                        <div class="mt-2 text-xs text-gray-500">
                            <strong>Sources:</strong>
                            ${sources.map(source => `<span class="inline-block bg-gray-100 px-2 py-1 rounded mr-1">${source.filename || 'Document'}</span>`).join('')}
                        </div>
                    `;
                }

                messageDiv.innerHTML = `
                    <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                        isUser 
                            ? 'bg-blue-600 text-white' 
                            : 'bg-gray-200 text-gray-800'
                    }">
                        <p class="text-sm">${isLoading ? '<span class="animate-pulse">‚óè‚óè‚óè</span> ' + content : content}</p>
                        ${sourcesHtml}
                    </div>
                `;

                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;

                return messageId;
            }

            removeChatMessage(messageId) {
                const element = document.getElementById(messageId);
                if (element) element.remove();
            }

            clearChatMessages() {
                this.chatMessages.innerHTML = `
                    <div id="welcome-message" class="text-gray-500 text-center py-8">
                        Ask questions about your documents - I'll search across all of them to find the best answers!
                    </div>
                `;
                this.welcomeMessage = document.getElementById('welcome-message');
            }

            showProgress(text = 'Processing...', percent = 0) {
                this.hideStatus();
                this.progressText.textContent = text;
                this.progressBar.style.width = `${percent}%`;
                this.uploadProgress.classList.remove('hidden');
            }

            showSuccess() {
                this.hideStatus();
                this.uploadSuccess.classList.remove('hidden');
            }

            showError(message) {
                this.hideStatus();
                this.errorMessage.textContent = message;
                this.uploadError.classList.remove('hidden');
            }

            hideStatus() {
                this.uploadProgress.classList.add('hidden');
                this.uploadSuccess.classList.add('hidden');
                this.uploadError.classList.add('hidden');
            }

            async loadExistingDocuments() {
                try {
                    console.log('Loading existing documents...');
                    const response = await fetch('/documents/list');
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Loaded documents:', result);
                        
                        if (result.documents && result.documents.length > 0) {
                            // Convert server format to client format
                            this.documents = result.documents.map(doc => ({
                                id: doc.id,
                                filename: doc.filename,
                                uploadedAt: new Date(), // Use current date as placeholder
                                chunks: doc.chunks_created,
                                fileSize: doc.file_size,
                                totalChunks: doc.total_chunks
                            }));
                            
                            this.updateDocumentList();
                            this.enableChat(); // Enable chat for all documents
                            
                            console.log(`Loaded ${this.documents.length} existing documents`);
                        } else {
                            console.log('No existing documents found');
                        }
                    } else {
                        console.error('Failed to load documents:', response.statusText);
                    }
                } catch (error) {
                    console.error('Error loading existing documents:', error);
                    // Don't show error to user - this is background loading
                }
            }
        }

        // Initialize the app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new PDFChatApp();
        });
    </script>
</body>
</html>